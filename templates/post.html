{% extends "layout.html" %}
{% block content %}
  <article class="content-section py-3 px-4 mb-4">
    <div class="d-flex align-items-start gap-4">
      <img class="rounded-circle article-img flex-shrink-0"
           src="{{ post.author.image_path }}"
           alt="{{ post.author.username }}'s profile picture"
           width="64"
           height="64"
           loading="lazy">
      <div class="flex-grow-1">
        <div class="article-metadata mb-2">
          <a class="me-2" href="{{ url_for('user_posts', user_id=post.author.id) }}">{{ post.author.username }}</a>
          <small class="text-body-secondary">{{ post.date_posted.strftime("%B %d, %Y") }}</small>
        </div>
        <h2 class="article-title">{{ post.title }}</h2>
        <p class="article-content">{{ post.content }}</p>
        <!-- Only show edit/delete options if the user is the author -->
        <!-- TODO: Add user authentication and authorization -->
        {% if post.user_id == 1 %}
        <div class="post-actions mt-3 pt-3 border-top">
          <button type="button" 
                  class="btn btn-outline-secondary me-1" 
                  data-bs-toggle="modal" 
                  data-bs-target="#editModal">Edit Post</button>
          <button type="button" 
                  class="btn btn-outline-danger" 
                  data-bs-toggle="modal" 
                  data-bs-target="#deleteModal">Delete Post</button>
        </div>
        {% endif %}
        <!-- TODO: Add user authentication and authorization -->
      </div>
    </div>
  </article>

  <!-- Edit Post Modal -->
  <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editModalLabel">Edit Post</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form id="editPostForm">
          <div class="modal-body">
            <input type="hidden" name="post_id" value="{{ post.id }}">
            <div class="mb-3">
              <label for="editTitle" class="form-label">Title</label>
              <input type="text" class="form-control" id="editTitle" name="title" value="{{ post.title }}" required>
            </div>
            <div class="mb-3">
              <label for="editContent" class="form-label">Content</label>
              <textarea class="form-control" id="editContent" name="content" rows="5"
                required>{{ post.content }}</textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="deleteModalLabel">Delete Post?</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="fs-5">Are you sure you want to delete this post? This action cannot be undone.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
        </div>
      </div>
    </div>
  </div>
{% endblock content %}
{% block scripts %}
    <script type="module">
    import {
      getErrorMessage,
      hideModal,
      showModal,
    } from "/static/js/utils.js";

    // Get post ID from Jinja2 template
    const postId = "{{ post.id }}";

    // Edit Post Form Handler
    const editForm = document.getElementById("editPostForm");
    editForm.addEventListener("submit", async (event) => {
      // Stop default form submission - we'll handle it with JavaScript
      event.preventDefault();

      // Gather form values into a plain object
      const formData = new FormData(editForm);
      const postData = Object.fromEntries(formData.entries());

      // Remove post_id from data (it's in the URL, not the body)
      delete postData.post_id;

      try {
        // PATCH for partial update (just title and content, not user_id)
        const response = await fetch(`/api/posts/${postId}`, {
          method: "PATCH",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(postData),
        });

        if (response.ok) {
          document.getElementById("successMessage").textContent =
            "Post updated successfully!";

          hideModal("editModal");
          showModal("successModal");

          document
            .getElementById("successModal")
            .addEventListener(
              "hidden.bs.modal",
              () => {
                window.location.reload();
              },
              { once: true },
            );
        } else {
          const error = await response.json();
          document.getElementById("errorMessage").textContent =
            getErrorMessage(error);

          hideModal("editModal");
          showModal("errorModal");
        }
      } catch (error) {
        document.getElementById("errorMessage").textContent =
          "Network error. Please check your connection and try again.";
        showModal("errorModal");
      }
    });

    // Delete Post Handler - listen for click on delete button
    const deleteButton = document.getElementById("confirmDelete");
    deleteButton.addEventListener("click", async () => {
      try {
        // DELETE request - no body needed, post_id is in the URL
        const response = await fetch(`/api/posts/${postId}`, {
          method: "DELETE",
        });

        // 204 = No Content (success)
        if (response.status === 204) {
          // Post is gone, redirect to home page
          window.location.href = "/";
        } else {
          const error = await response.json();
          document.getElementById("errorMessage").textContent =
            getErrorMessage(error);

          hideModal("deleteModal");
          showModal("errorModal");
        }
      } catch (error) {
        document.getElementById("errorMessage").textContent =
          "Network error. Please check your connection and try again.";
        showModal("errorModal");
      }
    });
    </script>
{% endblock scripts %}