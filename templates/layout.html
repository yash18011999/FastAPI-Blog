<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Site Info -->
    {% if title %}
      <title>FastAPI Blog - {{ title }}</title>
    {% else %}
      <title>FastAPI Blog</title>
    {% endif %}
    <meta name="description" content="FastAPI Tutorial">
    <meta name="author" content="Yashvardhan Chouhan">

    <!-- Open Graph Tags: The title of the page for social media sharing. It can match the title tag or be more descriptive. -->
    <meta property="og:title" content="FastAPI Blog">

    <!-- Open Graph Tags: Typically set to "website" for static sites or "article" for content-heavy pages. -->
    <meta property="og:type" content="website">

    <!-- Open Graph Tags: The URL of the page, used to ensure link previews resolve to the correct page. -->
    <meta property="og:url" content="">

    <!-- Open Graph Tags: URL of an image that represents the page. Useful for link previews. -->
    <meta property="og:image" content="">

    <!-- Open Graph Tags: Provides an alternative text for the image to improve accessibility. -->
    <meta property="og:image:alt" content="">

    <!-- Preconnect for Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- Custom Font -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&family=Nunito:ital,wght@0,200..1000;1,200..1000&display=swap"
          rel="stylesheet">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
          rel="stylesheet"
          integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB"
          crossorigin="anonymous">

    <!-- Stylesheet -->
    <link rel="stylesheet" type="text/css" href="/static/css/main.css">

    <!-- Set a theme color that matches your website's primary color -->
    <meta name="theme-color" content="#527c9f">

    <!-- Favicon for all browsers -->
    <link rel="icon" href="/static/icons/favicon.ico" sizes="any">
    <link rel="icon" href="/static/icons/icon.svg" type="image/svg+xml">

    <!-- Apple touch icon for iOS devices -->
    <link rel="apple-touch-icon" sizes="180x180" href="/static/icons/icon.png">
    <!-- Web app manifest for Progressive Web Apps -->
    <link rel="manifest" href="/static/site.webmanifest">

    <!-- Content Security Policy: Uncomment to enhance security by restricting where content can be loaded from (useful for preventing certain attacks like XSS). Update if adding external sources (e.g., Google Fonts, Bootstrap CDN, analytics, etc). -->
    <!-- <meta http-equiv="Content-Security-Policy" content=" default-src 'self'; script-src 'self' code.jquery.com; style-src 'self' fonts.googleapis.com; font-src fonts.gstatic.com; img-src 'self' images.examplecdn.com; "> -->
  </head>
  <body class="d-flex flex-column min-vh-100">
    <header class="site-header">
      <nav class="navbar navbar-expand-md bg-steel fixed-top"
           data-bs-theme="dark">
        <div class="container">
          <a class="navbar-brand me-4" href="{{ url_for('home') }}">FastAPI Blog</a>
          <button class="navbar-toggler"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#navbarToggle"
                  aria-controls="navbarToggle"
                  aria-expanded="false"
                  aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarToggle">
            <div class="navbar-nav me-auto">
              <a class="nav-link active" aria-current="page" href="{{ url_for('home') }}">Home</a>
            </div>
            <!-- Navbar Right Side -->
            <div class="navbar-nav">
              <!-- NOTE: Once auth is set up, this button will only be visible when logged in -->
              <button class="btn btn-outline-light mb-2 mb-md-0 me-md-2" type="button" data-bs-toggle="modal"
                data-bs-target="#createPostModal">New Post</button>
              <!-- NOTE: Once auth is set up, this button will only be visible when logged in -->
              <a class="btn btn-outline-light mb-2 mb-md-0 me-md-2" href="#">Login</a>
              <a class="btn btn-light mb-2 mb-md-0 me-md-3" href="#">Register</a>
              <div class="nav-item dropdown">
                <a class="nav-link dropdown-toggle"
                   href="#"
                   role="button"
                   id="bd-theme"
                   data-bs-toggle="dropdown"
                   aria-expanded="false">
                  <span id="bd-theme-text">üåó Auto</span>
                </a>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="bd-theme">
                  <li>
                    <button class="dropdown-item" type="button" data-bs-theme-value="light">üåù Light</button>
                  </li>
                  <li>
                    <button class="dropdown-item" type="button" data-bs-theme-value="dark">üåö Dark</button>
                  </li>
                  <li>
                    <button class="dropdown-item" type="button" data-bs-theme-value="auto">üåó Auto</button>
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main role="main" class="container">
      <div class="row">
        <div class="col-md-8">
          {% block content %}
          {% endblock content %}
        </div>
        <aside class="col-md-4">
          <div class="content-section py-3 px-4 mb-4">
            <h3>Our Sidebar</h3>
            <p class="text-body-secondary">You can put any information here you'd like.</p>
            <ul class="list-group">
              <li class="list-group-item">Latest Posts</li>
              <li class="list-group-item">Announcements</li>
              <li class="list-group-item">Calendars</li>
              <li class="list-group-item">etc</li>
            </ul>
          </div>
        </aside>
      </div>
    </main>

    <footer class="mt-auto py-3 bg-body-tertiary border-top">
      <div class="container text-center">
        <p class="text-body-secondary mb-0">
          ¬© <span id="year"></span> Yashvardhan Chouhan
        </p>
      </div>
    </footer>

    <!-- Create Post Modal -->
    <div class="modal fade" id="createPostModal" tabindex="-1" aria-labelledby="createPostModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="createPostModalLabel">New Post</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <form id="createPostForm">
            <div class="modal-body">
              <div class="mb-3">
                <label for="title" class="form-label">Title</label>
                <input type="text" class="form-control" id="title" name="title" required>
              </div>
              <div class="mb-3">
                <label for="content" class="form-label">Content</label>
                <textarea class="form-control" id="content" name="content" rows="5" required></textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-primary">Post</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    
    <!-- Success Modal -->
    <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-success text-white">
            <h5 class="modal-title" id="successModalLabel">Success</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p id="successMessage" class="fs-5"></p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Error Modal -->
    <div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title" id="errorModalLabel">Error</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p id="errorMessage" class="fs-5"></p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Set the current year in the footer -->
    <script>document.getElementById('year').textContent = new Date().getFullYear();</script>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
            crossorigin="anonymous"></script>

    <!-- Dark Mode Toggle -->
    <script>
      const setTheme = (theme) => {
        if (theme === 'auto') {
          document.documentElement.setAttribute('data-bs-theme', 
            window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        } else {
          document.documentElement.setAttribute('data-bs-theme', theme);
        }
        localStorage.setItem('theme', theme);
        
        // Update button text
        const themeText = { light: 'üåù Light', dark: 'üåö Dark', auto: 'üåó Auto' };
        document.getElementById('bd-theme-text').textContent = themeText[theme];
      };

      // Set theme on click
      document.querySelectorAll('[data-bs-theme-value]').forEach(button => {
        button.addEventListener('click', () => setTheme(button.getAttribute('data-bs-theme-value')));
      });

      // Initialize
      setTheme(localStorage.getItem('theme') || 'auto');
    </script>

    <!-- Create Post Form Handler -->
    <script type="module">
      import {
        getErrorMessage,
        hideModal,
        showModal,
      } from "/static/js/utils.js";

      const createForm = document.getElementById("createPostForm");

      createForm.addEventListener("submit", async (event) => {
        // Stop default form submission - we'll handle it with JavaScript
        event.preventDefault();

        // Gather form values into a plain object {title: "...", content: "..."}
        const formData = new FormData(createForm);
        const postData = Object.fromEntries(formData.entries());

        // TEMPORARY - hardcoded until authorization (Tutorial 11)
        postData.user_id = 1;

        try {
          // POST to our API as JSON
          const response = await fetch("/api/posts", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(postData),
          });

          if (response.ok) {
            const data = await response.json();
            document.getElementById("successMessage").textContent =
              `Post "${data.title}" created successfully!`;

            hideModal("createPostModal");
            showModal("successModal");

            // Clear form
            createForm.reset();

            // Reload page after modal is hidden to show new post
            document
              .getElementById("successModal")
              .addEventListener(
                "hidden.bs.modal",
                () => {
                  window.location.reload();
                },
                { once: true },
              );
          } else {
            const error = await response.json();
            document.getElementById("errorMessage").textContent =
              getErrorMessage(error);

            hideModal("createPostModal");
            showModal("errorModal");
          }
        } catch (error) {
          document.getElementById("errorMessage").textContent =
            "Network error. Please check your connection and try again.";
          showModal("errorModal");
        }
      });
    </script>
    {% block scripts %}
    {% endblock scripts %}
  </body>
</html>